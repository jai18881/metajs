/*
 * MetaJS - MetaPlatform project
 *
 * @author Jiri Hybek <jiri.hybek@cryonix.cz> / Cryonix Innovations <www.cryonix.cz>
 * @license MIT
 */
window.Meta||(window.Meta={}),window.Meta.Utils={},window.Meta.config||(window.Meta.config={}),window.Meta.config.importPrefix||(window.Meta.config.importPrefix="%module%.html"),window.Meta.Utils._importedModules=[],window.Meta.Utils["import"]=function(t,e,n){if(window.Meta.Utils._importedModules[t])return e();var i=document.createElement("link");i.rel="import",i.href=window.Meta.config.importPrefix.replace(/\%module\%/g,t),i.onload=function(){window.Meta.Utils._importedModules.push(t),e&&e()},i.onerror=function(e){console.log("Error importing meta module '"+t+"'",e),n&&n(e)},document.head.appendChild(i)},window.Meta.Utils.importMany=function(t,e,n){var i=function(t,e){window.Meta.Utils["import"](t,function(){return e()},function(){return e("Cannot import module '"+t+"'")})};window.Meta.Utils.batch(t,i,function(t){return t?n(t):e()})},window.Meta.Utils.batch=function(t,e,n){var i=-1,a=function(r){return i++,r?n(r):i==t.length?n():void e(t[i],a)};a()},window.Meta.Utils.idHashmap=function(t){for(var e={},n=t.querySelectorAll("*[id]"),i=0;i<n.length;i++)e[n.item(i).getAttribute("id")]=n.item(i);return e},window.Meta.Utils.sanitizeHtml=function(t){var e=new RegExp("<","g"),n=new RegExp("<","g");return String(t).replace(e,"&lt;").replace(n,"&gt;")},window.Meta.Utils.traverse=function(t,e){var n=e.shift();return t[n]?e.length>0?window.Meta.Utils.traverse(t[n],e):t[n]:void 0},window.Meta.Utils.formatDate=function(t,e){var n,i,a=this,r=["Sun","Mon","Tues","Wednes","Thurs","Fri","Satur","January","February","March","April","May","June","July","August","September","October","November","December"],o=/\\?(.?)/gi,s=function(t,e){return i[t]?i[t]():e},l=function(t,e){for(t=String(t);t.length<e;)t="0"+t;return t};return i={d:function(){return l(i.j(),2)},D:function(){return i.l().slice(0,3)},j:function(){return n.getDate()},l:function(){return r[i.w()]+"day"},N:function(){return i.w()||7},S:function(){var t=i.j(),e=t%10;return 3>=e&&1==parseInt(t%100/10,10)&&(e=0),["st","nd","rd"][e-1]||"th"},w:function(){return n.getDay()},z:function(){var t=new Date(i.Y(),i.n()-1,i.j()),e=new Date(i.Y(),0,1);return Math.round((t-e)/864e5)},W:function(){var t=new Date(i.Y(),i.n()-1,i.j()-i.N()+3),e=new Date(t.getFullYear(),0,4);return l(1+Math.round((t-e)/864e5/7),2)},F:function(){return r[6+i.n()]},m:function(){return l(i.n(),2)},M:function(){return i.F().slice(0,3)},n:function(){return n.getMonth()+1},t:function(){return new Date(i.Y(),i.n(),0).getDate()},L:function(){var t=i.Y();return t%4===0&t%100!==0|t%400===0},o:function(){var t=i.n(),e=i.W(),n=i.Y();return n+(12===t&&9>e?1:1===t&&e>9?-1:0)},Y:function(){return n.getFullYear()},y:function(){return i.Y().toString().slice(-2)},a:function(){return n.getHours()>11?"pm":"am"},A:function(){return i.a().toUpperCase()},B:function(){var t=3600*n.getUTCHours(),e=60*n.getUTCMinutes(),i=n.getUTCSeconds();return l(Math.floor((t+e+i+3600)/86.4)%1e3,3)},g:function(){return i.G()%12||12},G:function(){return n.getHours()},h:function(){return l(i.g(),2)},H:function(){return l(i.G(),2)},i:function(){return l(n.getMinutes(),2)},s:function(){return l(n.getSeconds(),2)},u:function(){return l(1e3*n.getMilliseconds(),6)},e:function(){throw"Not supported (see source code of date() for timezone on how to add support)"},I:function(){var t=new Date(i.Y(),0),e=Date.UTC(i.Y(),0),n=new Date(i.Y(),6),a=Date.UTC(i.Y(),6);return t-e!==n-a?1:0},O:function(){var t=n.getTimezoneOffset(),e=Math.abs(t);return(t>0?"-":"+")+l(100*Math.floor(e/60)+e%60,4)},P:function(){var t=i.O();return t.substr(0,3)+":"+t.substr(3,2)},T:function(){return"UTC"},Z:function(){return 60*-n.getTimezoneOffset()},c:function(){return"Y-m-d\\TH:i:sP".replace(o,s)},r:function(){return"D, d M Y H:i:s O".replace(o,s)},U:function(){return n/1e3|0}},this.date=function(t,e){return a=this,n=void 0===e?new Date:new Date(e instanceof Date?e:1e3*e),t.replace(o,s)},this.date(t,e)},window.Meta||(window.Meta={}),window.Meta.Template=function(t,e){var n=window.Meta.Template.processor(e);return function(e){n.call(t,{data:e})}},window.Meta.Template._context=function(t,e){var n={};for(var i in e)n[i]=e[i];return n.data=t.data,n},window.Meta.Template._value=function(t,e,n){if(n instanceof Function)return n.call(t,e.data,e);if("@"==n.substr(0,1)){var i=e;n=n.substr(1)}else var i=e.data;return n.indexOf(".")>=0?window.Meta.Utils.traverse(i,n.split(".")):i[n]},window.Meta.Template.processor=function(t){for(selector in t||{})if(t[selector]instanceof Array)for(var e=0;e<t[selector].length;e++)t[selector][e]instanceof Function||(t[selector][e]=window.Meta.Template.text(t[selector][e]));else t[selector]instanceof Function||(t[selector]=window.Meta.Template.text(t[selector]));var n=function(t,e,n){if(n instanceof Array)for(var i=0;i<n.length;i++)n[i].call(t,e);else n.call(t,e)};return function(e){for(selector in t||{})if(t[selector]instanceof Function&&t[selector].runInParentContext)t[selector].call(this,window.Meta.Template._context(e,{selector:selector}));else if("@"!=selector)for(var i=this.querySelectorAll(selector),a=0;a<i.length;a++)n(i.item(a),e,t[selector]);else n(this,e,t[selector])}},window.Meta.Template.filters={},window.Meta.Template.registerFilter=function(t,e){window.Meta.Template.filters[t]=e},window.Meta.Template.html=function(t){return function(e){this.innerHTML=window.Meta.Template._value(this,e,t)||""}},window.Meta.Template.text=function(t){return function(e){this.innerHTML=window.Meta.Utils.sanitizeHtml(window.Meta.Template._value(this,e,t))}},window.Meta.Template.string=function(t){for(var e=t.match(/#\{([a-zA-Z0-9_-]*)\}/g),n={},i=0;i<e.length;i++){var a=e[i].substr(2,e[i].length-3);n[a]=new RegExp("#\\{"+a+"\\}","g")}return function(e){var i=t;for(var a in n)i=i.replace(n[a],window.Meta.Template._value(this,e,a));this.innerHTML=i}},window.Meta.Template.fn=function(t){return function(e){this.innerHTML=t.call(this,e.data,e)}},window.Meta.Template.filter=function(t,e){return function(n){if(!window.Meta.Template.filters[t])throw"Template filter '"+t+"' not registered.";this.innerHTML=window.Meta.Template.filters[t].call(this,window.Meta.Template._value(this,n,e),n)}},window.Meta.Template.date=function(t,e){return function(n){var i=window.Meta.Template._value(this,n,t);return 0/0!==parseInt(i)&&i instanceof Date?void(this.innerHTML=window.Meta.Utils.formatDate(e,i)):this.innerHTML="NaN"}},window.Meta.Template["with"]=function(t,e){var n=window.Meta.Template.processor(e);return function(e){e.data[t]&&n.call(this,window.Meta.Template._context({data:e.data[t]},{parent:e.data}))}},window.Meta.Template.attr=function(t,e){return function(n){if(this instanceof ShadowRoot)var i=this.host;else var i=this;i.setAttribute(t,window.Meta.Template._value(this,n,e))}},window.Meta.Template.attrIf=function(t,e,n){return function(i){var a=window.Meta.Template._value(this,i,e);if(this instanceof ShadowRoot)var r=this.host;else var r=this;a?r.setAttribute(t,n?"":a):r.hasAttribute(t)&&r.removeAttribute(t)}},window.Meta.Template.property=function(t,e){return function(n){if(this instanceof ShadowRoot)var i=this.host;else var i=this;i[t]=e?window.Meta.Template._value(this,n,e):n.data}},window.Meta.Template._if=function(t,e){var n=window.Meta.Template.processor(t),i=function(t){var i=e.call(this,t);if(i){if(this.__ifRegistry&&this.__ifRegistry[t.selector]){for(var a=this.__ifRegistry[t.selector],r=0;r<a.length;r++)a[r].__nextSibling&&a[r].__nextSibling.parentElement==a[r].__parent?a[r].__parent.insertBefore(a[r],a[r].__nextSibling):a[r].__parent.appendChild(a[r]);delete this.__ifRegistry[t.selector]}for(var o=this.querySelectorAll(t.selector),r=0;r<o.length;r++)n.call(o.item(r),t)}else{var o=this.querySelectorAll(t.selector);this.__ifRegistry||(this.__ifRegistry={}),this.__ifRegistry[t.selector]||(this.__ifRegistry[t.selector]=[]);for(var r=0;r<o.length;r++)o.item(r).__parent=o.item(r).parentElement,o.item(r).__nextSibling=o.item(r).nextSibling,this.__ifRegistry[t.selector].push(o.item(r)),o.item(r).parentElement.removeChild(o.item(r))}};return i.runInParentContext=!0,i},window.Meta.Template["if"]=function(t,e){return window.Meta.Template._if(e,function(e){return window.Meta.Template._value(this,e,t)?!0:!1})},window.Meta.Template.ifNot=function(t,e){return window.Meta.Template._if(e,function(e){return window.Meta.Template._value(this,e,t)?!1:!0})},window.Meta.Template.ifLt=function(t,e,n){return window.Meta.Template._if(n,function(n){return window.Meta.Template._value(this,n,t)<e?!0:!1})},window.Meta.Template.ifLte=function(t,e,n){return window.Meta.Template._if(n,function(n){return window.Meta.Template._value(this,n,t)<=e?!0:!1})},window.Meta.Template.ifGt=function(t,e,n){return window.Meta.Template._if(n,function(n){return window.Meta.Template._value(this,n,t)>e?!0:!1})},window.Meta.Template.ifGte=function(t,e,n){return window.Meta.Template._if(n,function(n){return window.Meta.Template._value(this,n,t)>=e?!0:!1})},window.Meta.Template.repeat=function(t,e){var n=window.Meta.Template.processor(e),i=function(t){var e=[];if(t instanceof Array)for(var n=0;n<t.length;n++)e[n]=t[n];else{if(!(t instanceof Object))return null;var i=0;for(var n in t||{})e[i]=n,i++}return e},a=function(e){if(this.__repeatTemplate||(this.__repeatTemplate={}),!this.__repeatTemplate[e.selector]){this.__repeatTemplate[e.selector]=[];for(var a=this.querySelectorAll(e.selector),r=0;r<a.length;r++)a.item(r).__parent=a.item(r).parentElement,this.__repeatTemplate[e.selector].push(a.item(r)),a.item(r).parentElement.removeChild(a.item(r))}var o=this,s=[],l={},w=null,u=window.Meta.Template._value(this,e,t),c=i(u);if(c){for(var a=this.querySelectorAll(e.selector),r=0;r<a.length;r++){var f=c.indexOf(a.item(r).__id);f>=0?(l[f]||(l[f]=[]),l[f].push(a.item(r))):s.push(a.item(r))}for(var d=0;d<s.length;d++)s[d].parentElement.removeChild(s[d]);delete s;for(var r=0;r<c.length;r++){if(c[r]instanceof Object)var h=c[r];else var h=u[c[r]];if(l[r])for(var m=0;m<l[r].length;m++)l[r][m]instanceof HTMLElement&&n.call(l[r][m],window.Meta.Template._context({data:h},{parent:e.data,key:r})),l[r][m].previousElementSibling!=w&&l[r][m].parentElement.appendChild(l[r][m]),w=l[r][m];else for(var p=0;p<o.__repeatTemplate[e.selector].length;p++){var g=o.__repeatTemplate[e.selector][p].cloneNode(!0);g.__id=c[r],o.__repeatTemplate[e.selector][p].__parent.appendChild(g),n.call(g,window.Meta.Template._context({data:h},{parent:e.data,key:r})),w=g}}}};return a.runInParentContext=!0,a},window.$__html=window.Meta.Template.html,window.$__text=window.Meta.Template.text,window.$__string=window.Meta.Template.string,window.$__fn=window.Meta.Template.fn,window.$__filter=window.Meta.Template.filter,window.$__date=window.Meta.Template.date,window.$__attr=window.Meta.Template.attr,window.$__attrIf=window.Meta.Template.attrIf,window.$__prop=window.Meta.Template.property,window.$__if=window.Meta.Template["if"],window.$__ifNot=window.Meta.Template.ifNot,window.$__ifLt=window.Meta.Template.ifLt,window.$__ifLte=window.Meta.Template.ifLte,window.$__ifGt=window.Meta.Template.ifGt,window.$__ifGte=window.Meta.Template.ifGte,window.$__repeat=window.Meta.Template.repeat,window.$__with=window.Meta.Template["with"],window.Meta||(window.Meta={}),window.Meta.views={},window.Meta.ViewPrototype=Object.create(HTMLTemplateElement.prototype),window.Meta.ViewPrototype.createdCallback=function(){this.hasAttribute("name")&&(window.Meta.views[this.getAttribute("name")]=this)},window.Meta.ViewPrototype.instance=function(t,e){var n=this,i={target:null,template:null,model:{},events:{},eventsContext:null,configure:function(t,e){i.target=t,i.target._templateInstanced||(i.target.innerHTML="",i.target.appendChild(document.importNode(n.content,!0)),i.target._templateInstanced=!0),i.template=window.Meta.Template(t,e)},on:function(t,e,n){i.events[t+" "+e]=n},_bindEvents:function(){var t=function(t,e,n){if(!(t._boundEvents&&t._boundEvents.indexOf(e)>=0)){var a=function(e){e.sender=t,n.call(i.eventsContext||this,e)};a.eventName=e,t.addEventListener(e,a),t._boundEvents||(t._boundEvents=[]),t._boundEventHandlers||(t._boundEventHandlers=[]),t._boundEvents.push(e),t._boundEventHandlers.push(a)}};for(var e in i.events){var n=e.split(" "),a=n.shift(),r=n.join(" ");if(""!=r)var o=i.target.querySelectorAll(r);else if(i.target instanceof ShadowRoot)var o=[i.target.host];else var o=[i.target];for(var s=0;s<o.length;s++)t(o[s],a,i.events[e])}},_unbindEvents:function(){for(var t in i.events){var e=t.split(" "),n=(e.shift(),e.join(" "));if(""!=n)var a=i.target.querySelectorAll(n);else if(i.target instanceof ShadowRoot)var a=[i.target.host];else var a=[i.target];for(var r=0;r<a.length;r++)if(a[r]._boundEventHandlers){for(var t=0;t<a[r]._boundEventHandlers.length;t++)a[r].removeEventListener(a[r]._boundEventHandlers[t].eventName,a[r]._boundEventHandlers[t]);a[r]._boundEvents=[],a[r]._boundEventHandlers=[]}}},render:function(){if(!i.template)throw"Template is not configured.";i.template(i.model),i._bindEvents(),i.$=window.Meta.Utils.idHashmap(i.target)},find:function(t){return i.target.querySelector(t)},findAll:function(t){return i.target.querySelectorAll(t)}};return i.eventsContext=i,t&&e&&i.configure(t,e),i},document.registerElement("meta-view",{prototype:window.Meta.ViewPrototype,"extends":"template"}),window.Meta||(window.Meta={}),window.Meta.fragments={},window.Meta.Fragment=function(t,e){if(void 0==e.shadowRoot&&(e.shadowRoot=!0),e["extends"]){e["extends"]instanceof Array||(e["extends"]=[e["extends"]]);for(var n=0;n<e["extends"].length;n++){if(!window.Meta.fragments[e["extends"][n]])throw"Cannot register fragment '"+t+"': parent fragment '"+e["extends"][n]+"' not found.";for(var i in window.Meta.fragments[e["extends"][n]])e[i]=window.Meta.fragments[e["extends"][n]][i]}}window.Meta.fragments[t]=e},window.Meta.FragmentPrototype=Object.create(HTMLElement.prototype),window.Meta.FragmentPrototype._defaultMethods=["onCreate","onResume","onPause","onRender"],window.Meta.FragmentPrototype._getConfig=function(t){return window.Meta.fragments[t]||null},window.Meta.FragmentPrototype.create=function(){this.model=this.config.model?Object.create(this.config.model):{},this.config.onCreate&&this.config.onCreate.call(this,this),this._created=!0,this.fireEvent("create"),(this.parentElement&&this._auto||this._callStack.length>0)&&this.resume()},window.Meta.FragmentPrototype.resume=function(t){if(!this._paused)return t?t():void 0;if(this._callStack.push({fn:t||null,args:[],context:this}),this._created){this.config.view&&!this.view&&this.setView(this.config.view),this.render();var e=this,n=function(t,e){t.resume(e)},i=this.fragmentRoot.querySelectorAll("meta-fragment, meta-activity");window.Meta.Utils.batch(i,n,function(){e._paused=!1,e.config.onResume&&e.config.onResume.call(e,e);for(var t in e._callStack)e._callStack[t].fn&&e._callStack[t].fn.apply(e._callStack[t].context,e._callStack[t].args);e._callStack=[]})}},window.Meta.FragmentPrototype.pause=function(t){if(!this._created||this._paused)return t?t():void 0;this.view&&this.view._unbindEvents();var e=this,n=function(t,e){t.pause(e)},i=this.fragmentRoot.querySelectorAll("meta-fragment, meta-activity");window.Meta.Utils.batch(i,n,function(){e._paused=!0,e.config.onPause&&e.config.onPause.call(e,e),t&&t()})},window.Meta.FragmentPrototype.bindMethod=function(t,e,n){t[k]=function(){return!t._created||t._paused?t._callStack.push({fn:n,args:arguments,context:t}):void n.apply(t,arguments)}},window.Meta.FragmentPrototype.setView=function(t){if("string"==typeof t){if(!window.Meta.views[t])throw"Meta view '"+t+"' not registered.";this.view=window.Meta.views[t].instance()}else this.view=t.instance();this.view.configure(this.fragmentRoot,this.config.binding||{}),this.view.model=this.model,this.view.events=this.config.events||{},this.view.eventsContext=this,this.view.fragment=this},window.Meta.FragmentPrototype.render=function(){this.view&&this.view.render(),this.$=this.view.$,this.config.onRender&&this.config.onRender.call(this,this)},window.Meta.FragmentPrototype.createdCallback=function(){if(this.name=this.getAttribute("name"),this._created=!1,this._auto=this.hasAttribute("auto")?!0:!1,this._paused=!0,this._callStack=[],this.config=this._getConfig(this.name),!this.config)throw"Fragment '"+this.name+"' not registered.";for(k in this.config)this.config[k]instanceof Function&&window.Meta.FragmentPrototype._defaultMethods.indexOf(k)<0&&this.bindMethod(this,k,this.config[k]);this.fragmentRoot=this.config.shadowRoot?this.createShadowRoot():this;var t=this;this.config["import"]?window.Meta.Utils.importMany(this.config["import"],function(){t.create()},function(){throw"Imports for fragment '"+t.name+"' failed"}):t.create()},window.Meta.FragmentPrototype.attachedCallback=function(){this._created&&this._auto&&this.resume()},window.Meta.FragmentPrototype.dettachedCallback=function(){this._created&&this._auto&&this.pause()},window.Meta.FragmentPrototype.fireEvent=function(t,e){var n=new CustomEvent(t);n.fragment=this;for(var i in e)n[i]=e[i];this.dispatchEvent(n)},document.registerElement("meta-fragment",{prototype:window.Meta.FragmentPrototype});