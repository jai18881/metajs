/*
 * MetaJS - MetaPlatform project
 *
 * @author Jiri Hybek <jiri.hybek@cryonix.cz> / Cryonix Innovations <www.cryonix.cz>
 * @license MIT
 */
window.Meta||(window.Meta={}),window.Meta.activities={},window.Meta.Activity=function(e,t){void 0==t.shadowRoot&&(t.shadowRoot=!0),void 0==t.observeModel&&(t.observeModel=!0),window.Meta.activities[e]=t},window.Meta.CreateActivity=function(e,t){if(!window.Meta.activities[t])throw"Activity '"+t+"' not registered.";var i=document.createElement("meta-activity");i.setAttribute("name",t),e.appendChild(i)},window.Meta.ActivityPrototype=Object.create(window.Meta.FragmentPrototype),window.Meta.ActivityPrototype._getConfig=function(e){if(!window.Meta.activities[e])throw"Activity '"+e+"' not registered.";this.config=window.Meta.activities[e]},document.registerElement("meta-activity",{prototype:window.Meta.ActivityPrototype}),window.Meta||(window.Meta={}),window.Meta.fragments={},window.Meta.Fragment=function(e,t){void 0==t.shadowRoot&&(t.shadowRoot=!0),window.Meta.fragments[e]=t},window.Meta.FragmentPrototype=Object.create(HTMLElement.prototype),window.Meta.FragmentPrototype._getConfig=function(e){if(!window.Meta.fragments[e])throw"Fragment '"+e+"' not registered.";this.config=window.Meta.fragments[e]},window.Meta.FragmentPrototype._create=function(){this.model={},this.config.view&&this.setView(this.config.view),this.config.onCreate&&this.config.onCreate.call(this,this),this.fireEvent("create"),this.view.render(),this.config.onReady&&this.config.onReady.call(this,this)},window.Meta.FragmentPrototype.setView=function(e){if("string"==typeof e){if(!window.Meta.views[e])throw"Meta view '"+e+"' not registered.";this.view=window.Meta.views[e].instance()}else this.view=e.instance();this.view.model=this.model,this.view.map=this.config.map||{},this.view.filters=this.config.filters||{},this.view.conditions=this.config.conditions||{},this.view.bindings=this.config.bindings||{},this.view.events=this.config.events||{},this.view.fragment=this,this.view.target=this.config.shadowRoot?this.shadow:this},window.Meta.FragmentPrototype.render=function(){this.view&&this.view.render()},window.Meta.FragmentPrototype.attachedCallback=function(){var e=this;this.name=this.getAttribute("name"),this._getConfig(this.name);for(k in this.config)this.config[k]instanceof Function&&["onCreate"].indexOf(k)<0&&(this[k]=this.config[k]);this.config.shadowRoot&&(this.shadow=this.createShadowRoot()),this.config["import"]?window.Meta.Utils.importMany(this.config["import"],function(){e._create()},function(){throw"Imports for fragment '"+e.name+"' failed"}):e._create()},window.Meta.FragmentPrototype.fireEvent=function(e,t){var i=new CustomEvent(e);i.fragment=this;for(var n in t)i[n]=t[n];this.dispatchEvent(i)},document.registerElement("meta-fragment",{prototype:window.Meta.FragmentPrototype}),window.Meta||(window.Meta={}),window.Meta.EventsPrototype={eventListeners:{},on:function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)},off:function(e,t){if(this.eventListeners[e]){var i=this.eventListeners[e].indexOf(t);i>=0&&this.eventListeners[e].splice(i,1)}},fire:function(e,t){if(this.eventListeners[e])for(var i=0;i<this.eventListeners[e].length;i++)this.eventListeners[e][i].call(this,t)}},window.Meta.ObservingProvider=function(e){if(this.addObserver(this),e)for(k in e)this[k]=e[k]},window.Meta.ObservingProvider.prototype=Object.create(window.Meta.EventsPrototype),window.Meta.ObservingProvider.prototype.addObserver=function(e){var t=this;e instanceof Array?Array.observe(e,function(e){for(var i=0;i<e.length;i++){var n=e[i];n.addedCount>0&&n.object[n.index]instanceof Object&&t.addObserver(n.object[n.index])}t.fire("changed",t)}):Object.observe(e,function(e){for(var i=0;i<e.length;i++){var n=e[i];"add"==n.type&&n.object[n.name]instanceof Object&&t.addObserver(n.object[n.name])}t.fire("changed",t)})},window.Meta||(window.Meta={}),window.Meta.Template=function(e,t){var i=window.Meta.Template.processor(t);return function(t){i.call(e,t)}},window.Meta.Template._context=function(e,t){var i={};for(var n in e)"@"!=n.substr(0,1)&&(i[n]=e[n]);for(var n in t)i["@"+n]=t[n];return i},window.Meta.Template._value=function(e,t,i){return i instanceof Function?i.call(e,t):i.indexOf(".")?window.Meta.Utils.traverse(t,i.split(".")):t[i]},window.Meta.Template.processor=function(e){for(selector in e||{})if(e[selector]instanceof Array)for(var t=0;t<e[selector].length;t++)e[selector][t]instanceof Function||(e[selector][t]=window.Meta.Template.text(e[selector][t]));else e[selector]instanceof Function||(e[selector]=window.Meta.Template.text(e[selector]));var i=function(e,t,i){if(i instanceof Array)for(var n=0;n<i.length;n++)i[n].call(e,t);else i.call(e,t)};return function(t){for(selector in e||{})if(e[selector]instanceof Function&&e[selector].runInParentContext)e[selector].call(this,window.Meta.Template._context(t,{selector:selector}));else if("@"!=selector)for(var n=this.querySelectorAll(selector),o=0;o<n.length;o++)i(n.item(o),t,e[selector]);else i(this,t,e[selector])}},window.Meta.Template.filters={},window.Meta.Template.registerFilter=function(e,t){window.Meta.Template.filters[e]=t},window.Meta.Template.html=function(e){return function(t){this.innerHTML=window.Meta.Template._value(this,t,e)||""}},window.Meta.Template.text=function(e){return function(t){this.innerHTML=window.Meta.Utils.sanitizeHtml(window.Meta.Template._value(this,t,e)||"")}},window.Meta.Template.string=function(e){for(var t=e.match(/#\{([a-zA-Z0-9_-]*)\}/g),i={},n=0;n<t.length;n++){var o=t[n].substr(2,t[n].length-3);i[o]=new RegExp("#\\{"+o+"\\}","g")}return function(t){var n=e;for(var o in i)n=n.replace(i[o],t[o]||"");this.innerHTML=n}},window.Meta.Template.fn=function(e){return function(t){this.innerHTML=e.call(this,t)}},window.Meta.Template.filter=function(e,t){return function(i){if(!window.Meta.Template.filters[e])throw"Template filter '"+e+"' not registered.";this.innerHTML=window.Meta.Template.filters[e].call(this,window.Meta.Template._value(this,i,t),i)}},window.Meta.Template["with"]=function(e,t){var i=window.Meta.Template.processor(t);return function(t){i.call(this,window.Meta.Template._context(t[e],{parent:t}))}},window.Meta.Template.attr=function(e,t){return function(i){this.setAttribute(e,window.Meta.Template._value(this,i,t))}},window.Meta.Template.attrIf=function(e,t,i){return function(n){var o=window.Meta.Template._value(this,n,t);o?this.setAttribute(e,i?"":o):this.hasAttribute(e)&&this.removeAttribute(e)}},window.Meta.Template.property=function(e,t){return function(i){this[e]=t?window.Meta.Template._value(this,i,t):i}},window.Meta.Template._if=function(e,t){var i=window.Meta.Template.processor(e),n=function(e){var n=t.call(this,e);if(n){if(this.__ifRegistry&&this.__ifRegistry[e["@selector"]]){for(var o=this.__ifRegistry[e["@selector"]],r=0;r<o.length;r++)o[r].__nextSibling&&o[r].__nextSibling.parentElement==o[r].__parent?o[r].__parent.insertBefore(o[r],o[r].__nextSibling):o[r].__parent.appendChild(o[r]);delete this.__ifRegistry[e["@selector"]]}for(var a=this.querySelectorAll(e["@selector"]),r=0;r<a.length;r++)i.call(a.item(r),e)}else{var a=this.querySelectorAll(e["@selector"]);this.__ifRegistry||(this.__ifRegistry={}),this.__ifRegistry[e["@selector"]]||(this.__ifRegistry[e["@selector"]]=[]);for(var r=0;r<a.length;r++)a.item(r).__parent=a.item(r).parentElement,a.item(r).__nextSibling=a.item(r).nextSibling,this.__ifRegistry[e["@selector"]].push(a.item(r)),a.item(r).parentElement.removeChild(a.item(r))}};return n.runInParentContext=!0,n},window.Meta.Template["if"]=function(e,t){return window.Meta.Template._if(t,function(t){return window.Meta.Template._value(this,t,e)?!0:!1})},window.Meta.Template.ifNot=function(e,t){return window.Meta.Template._if(t,function(t){return window.Meta.Template._value(this,t,e)?!1:!0})},window.Meta.Template.ifLt=function(e,t,i){return window.Meta.Template._if(i,function(i){return window.Meta.Template._value(this,i,e)<t?!0:!1})},window.Meta.Template.ifLte=function(e,t,i){return window.Meta.Template._if(i,function(i){return window.Meta.Template._value(this,i,e)<=t?!0:!1})},window.Meta.Template.ifGt=function(e,t,i){return window.Meta.Template._if(i,function(i){return window.Meta.Template._value(this,i,e)>t?!0:!1})},window.Meta.Template.ifGte=function(e,t,i){return window.Meta.Template._if(i,function(i){return window.Meta.Template._value(this,i,e)>=t?!0:!1})},window.Meta.Template.repeat=function(e,t){var i=window.Meta.Template.processor(t),n=function(e){var t=[];if(e instanceof Array)for(var i=0;i<e.length;i++)t[i]=e[i];else{var n=0;for(var i in e||{})t[n]=i,n++}return t},o=function(t){if(this.__repeatTemplate||(this.__repeatTemplate={}),!this.__repeatTemplate[t["@selector"]]){this.__repeatTemplate[t["@selector"]]=[];for(var o=this.querySelectorAll(t["@selector"]),r=0;r<o.length;r++)o.item(r).__parent=o.item(r).parentElement,this.__repeatTemplate[t["@selector"]].push(o.item(r)),o.item(r).parentElement.removeChild(o.item(r))}for(var a=this,l=[],s={},d=null,w=window.Meta.Template._value(this,t,e),c=n(w),o=this.querySelectorAll(t["@selector"]),r=0;r<o.length;r++){var f=c.indexOf(o.item(r).__id);f>=0?(s[f]||(s[f]=[]),s[f].push(o.item(r))):l.push(o.item(r))}for(var p=0;p<l.length;p++)l[p].parentElement.removeChild(l[p]);delete l;for(var r=0;r<c.length;r++){if(c[r]instanceof Object)var m=c[r];else var m=w[c[r]];if(s[r])for(var u=0;u<s[r].length;u++)s[r][u]instanceof HTMLElement&&i.call(s[r][u],window.Meta.Template._context(m,{parent:t,key:r})),s[r][u].previousSibling!=d&&s[r][u].parentElement.appendChild(s[r][u]),d=s[r][u];else for(var h=0;h<a.__repeatTemplate[t["@selector"]].length;h++){var v=a.__repeatTemplate[t["@selector"]][h].cloneNode(!0);v.__id=c[r],a.__repeatTemplate[t["@selector"]][h].__parent.appendChild(v),i.call(v,window.Meta.Template._context(m,{parent:t,key:r})),d=v}}};return o.runInParentContext=!0,o},window.$__html=window.Meta.Template.html,window.$__text=window.Meta.Template.text,window.$__string=window.Meta.Template.string,window.$__fn=window.Meta.Template.fn,window.$__filter=window.Meta.Template.filter,window.$__attr=window.Meta.Template.attr,window.$__attrIf=window.Meta.Template.attrIf,window.$__prop=window.Meta.Template.property,window.$__if=window.Meta.Template["if"],window.$__ifNot=window.Meta.Template.ifNot,window.$__ifLt=window.Meta.Template.ifLt,window.$__ifLte=window.Meta.Template.ifLte,window.$__ifGt=window.Meta.Template.ifGt,window.$__ifGte=window.Meta.Template.ifGte,window.$__repeat=window.Meta.Template.repeat,window.$__with=window.Meta.Template["with"],window.Meta||(window.Meta={}),window.Meta.Template={bind:function(e,t){for(var i in t){var n=e.querySelectorAll('*[id="'+i+'"], *[class~="'+i+'"]');if(t[i]instanceof Array)for(var o=0;o<n.length;o++){n.item(o)._template||(n.item(o)._template=n.item(o).cloneNode(!0));for(var r=[],a={},l=0;l<n.item(o).childNodes.length;l++){var s=n.item(o).childNodes.item(l),d=t[i].indexOf(s._model||void 0);d>=0?(a[d]||(a[d]=[]),a[d].push(s)):r.push(s)}for(var l=0;l<r.length;l++)n.item(o).removeChild(r[l]);for(var w=0;w<t[i].length;w++)if(a[w])for(var c=0;c<a[w].length;c++)n.item(o).appendChild(a[w][c]);else{var f=n.item(i)._template.cloneNode(!0);for(window.Meta.Template.bind(f,t[i][w]);f.childNodes.length>0;)console.log(f.childNodes.item(0)),f.childNodes.item(0)._model=t[i][w],n.item(o).appendChild(f.childNodes.item(0))}}else for(var o=0;o<n.length;o++)n.item(i).innerHTML=t[i]}},_parseQuery:function(e){var t={selector:e,type:0,subtype:0,property:null};if(e.indexOf("@")>=0){var i=e.indexOf("@"),n=e.substring(i+1);t.selector=e.substring(0,i),t.type=1,"??"==n.substr(0,2)?(t.subtype=2,t.property=n.substr(2)):"?"==n.substr(0,1)?(t.subtype=1,t.property=n.substr(1)):t.property=n}else if(e.indexOf("$")>=0){var i=e.indexOf("$");t.type=2,t.property=e.substring(i+1),t.selector=e.substring(0,i)}return t},_selector:function(e,t){return e.matches&&e.matches(t)?e:e.querySelector(t)},_modifyNode:function(e,t,i){1==t.type?0==t.subtype?e.setAttribute(t.property,i):1==t.subtype?i?e.setAttribute(t.property,i):e.hasAttribute(t.property)&&e.removeAttribute(t.property):2==t.subtype&&(i?e.setAttribute(t.property,""):e.hasAttribute(t.property)&&e.removeAttribute(t.property)):2==t.type?e[t.property]=i:e.innerHTML=i},_bindRoot:function(e,t,i,n){if(t.model instanceof Array)window.Meta.Template._bindArray(e,t,i,n);else{if(!(i instanceof Object))throw"Template model must be an object or an array.";for(var o in i)window.Meta.Template._bindElement(e,t,o,i,i[o],(n?n+".":"")+o)}},_bindElement:function(e,t,i,n,o,r){var a='*[id="'+i+'"], *[class~="'+i+'"], *[name="'+i+'"]';t.map[r]&&(a=t.map[r]);var l=window.Meta.Template._parseQuery(a);if(l.key=i,l.path=r,t.conditions[r]){var s=window.Meta.Template._selector(e,l.selector);if(e._conditionals||(e._conditionals={}),!e._conditionals[r]){if(!s)return;e._conditionals[r]=s.cloneNode(!0),e._conditionals[r]._nextSibling=s.nextSibling,e._conditionals[r]._parent=s.parentElement}var d=!1;if(t.conditions[r]instanceof Function?d=t.conditions[r].call(n,o,i,r,t):o&&(d=!0),d){if(!s){var w=e._conditionals[r];w._nextSibling?w._parent.insertBefore(w.cloneNode(!0),w._nextSibling):w._parent.appendChild(w.cloneNode(!0))}}else console.log(s),s&&s.parentElement&&s.parentElement.removeChild(s)}var c=window.Meta.Template._selector(e,l.selector);if(c)if(o instanceof Array)window.Meta.Template._bindArray(c,t,o,r);else if(o instanceof Object&&2!=l.type&&!(o instanceof Date))for(var f in o)window.Meta.Template._bindElements(c,t,f,o[f],r+"."+f);else{if(t.map[r]===!1)return;if(0==l.type)if(t.filters[r])var p=t.filters[r].call(n,o,l);else var p=window.Meta.Utils.sanitizeHtml(o);else var p=o;window.Meta.Template._modifyNode(c,l,p)}},_bindArray:function(e,t,i,n){e._template||(e._template=e.cloneNode(!0));for(var o=[],r={},a=null,l=0;l<e.childNodes.length;l++){var s=e.childNodes.item(l),d=i.indexOf(s._model||void 0);d>=0?(r[d]||(r[d]=[]),r[d].push(s)):o.push(s)}for(var l=0;l<o.length;l++)e.removeChild(o[l]);for(delete o,k=0;k<i.length;k++)if(r[k])for(var w=0;w<r[k].length;w++)r[k][w]instanceof HTMLElement&&(window.Meta.Template._bindRoot(r[k][w],t,i[k],n),window.Meta.Template._bindRoot(r[k][w],t,{_key:k},n)),r[k][w].previousSibling!=a&&e.appendChild(r[k][w]),a=r[k][w];else{var c=e._template.cloneNode(!0);for(window.Meta.Template._bindRoot(c,t,i[k],n),window.Meta.Template._bindRoot(c,t,{_key:k},n);c.childNodes.length>0;)a=c.childNodes.item(0),c.childNodes.item(0)._model=i[k],e.appendChild(c.childNodes.item(0))}},_bindEvents:function(e,t,i){var n=function(e,t,n){e._boundEvents&&e._boundEvents.indexOf(t)>=0||(e.addEventListener(t,function(t){t.sender=e,n.call(i||this,t)}),e._boundEvents||(e._boundEvents=[]),e._boundEvents.push(t))};for(var o in t)for(var r=o.split(" "),a=r.shift(),l=r.join(" "),s=e.querySelectorAll(l),d=0;d<s.length;d++)n(s.item(d),a,t[o])},_bindExplicit:function(e,t,i){for(var n in i)for(var o=window.Meta.Template._parseQuery(n),r=e.querySelectorAll(o.selector),a=0;a<r.length;a++){var l=r.item(a),s=i[n].call(l,t,o);window.Meta.Template._modifyNode(l,o,s)}},render:function(e,t){t.model?(t.map=t.map||{},t.filters=t.filters||{},t.conditions=t.conditions||{},t.bindings=t.bindings||{},t.events=t.events||{},t.eventsContext=t.eventsContext||null):t={model:t,map:{},filters:{},conditions:{},bindings:{},events:{},eventsContext:null},window.Meta.Template._bindRoot(e,t,t.model,null),window.Meta.Template._bindExplicit(e,t.model,t.bindings),window.Meta.Template._bindEvents(e,t.events,t.eventsContext)}},window.Meta||(window.Meta={}),window.Meta.Utils={},window.Meta.config||(window.Meta.config={}),window.Meta.config.importPrefix||(window.Meta.config.importPrefix="%module%.html"),window.Meta.Utils._importedModules=[],window.Meta.Utils["import"]=function(e,t,i){if(window.Meta.Utils._importedModules[e])return t();var n=document.createElement("link");n.rel="import",n.href=window.Meta.config.importPrefix.replace(/\%module\%/g,e),n.onload=function(){window.Meta.Utils._importedModules.push(e),t&&t()},n.onerror=function(t){console.log("Error importing meta module '"+e+"'",t),i&&i(t)},document.head.appendChild(n)},window.Meta.Utils.importMany=function(e,t,i){var n=function(e,t){window.Meta.Utils["import"](e,function(){return t()},function(){return t("Cannot import module '"+e+"'")})};window.Meta.Utils.batch(e,n,function(e){return e?i(e):t()})},window.Meta.Utils.batch=function(e,t,i){var n=-1,o=function(r){return n++,r?i(r):n==e.length?i():void t(e[n],o)};o()},window.Meta.Utils.idHashmap=function(e){for(var t={},i=e.querySelectorAll("*[id]"),n=0;n<i.length;n++)t[i.item(n).getAttribute("id")]=i.item(n);return t},window.Meta.Utils.sanitizeHtml=function(e){var t=new RegExp("<","g"),i=new RegExp("<","g");return String(e).replace(t,"&lt;").replace(i,"&gt;")},window.Meta.Utils.traverse=function(e,t){var i=t.shift();return e[i]?t.length>0?window.Meta.Utils.traverse(e[i],t):e[i]:void 0},window.Meta||(window.Meta={}),window.Meta.views={},window.Meta.ViewPrototype=Object.create(HTMLTemplateElement.prototype),window.Meta.ViewPrototype.createdCallback=function(){this.hasAttribute("name")&&(window.Meta.views[this.getAttribute("name")]=this)},window.Meta.ViewPrototype.instance=function(e){var t=this,i={target:e,model:{},map:{},filters:{},conditions:{},bindings:{},events:{},eventsContext:null,on:function(e,t,n){i.events[e+" "+t]=n},render:function(){i.target._templateInstanced||(i.target.appendChild(document.importNode(t.content,!0)),i.target._templateInstanced=!0),window.Meta.Template.render(i.target,i),i.$=window.Meta.Utils.idHashmap(i.target)},find:function(e){return i.target.querySelector(e)},findAll:function(e){return i.target.querySelectorAll(e)}};return i.eventsContext=i,i},document.registerElement("meta-view",{prototype:window.Meta.ViewPrototype,"extends":"template"});