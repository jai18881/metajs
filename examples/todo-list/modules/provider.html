<html>

	<script type="text/javascript">

		/*
		 * To-do list
		 */
		window.TodoList = function(model, name, items){

			this.model = model;

			this.name = name;
			this.items = items || [];

		}

		window.TodoList.rename = function(name){

			this.name = name;

			this.model._changed();

		}

		window.TodoList.addTask = function(task){

			this.items.unshift({
				task: item,
				completed: false
			});

			this.model._changed();

		}

		window.TodoList.removeTask = function(task){

			var index = this.items.indexOf(task);

			if(index < 0) throw "Task not found";

			this.items.splice(index, 1);

			this.model._changed();

		}

		window.TodoList.markTask = function(task){

			task.completed = !task.completed;

			this.model._changed();

		}

		/*
		 * To-do model
		 */
		window.TodoProvider = function(){

			this.lists = [
				new TodoList(this, "Default list"),
				new TodoList(this, "Another list")
			];

		}

		window.TodoProvider.prototype = Object.create(window.Meta.EventsPrototype);

		window.TodoProvider.prototype.load = function(){

			var storedData = localStorage.getItem("com.example.todoList.lists");

			if(storedData){

				var lists = JSON.parse(storedData);

				for(var i = 0; i < lists.length; i++)
					this.lists.push( new TodoList(this, lists[i].name, lists[i].items) );

			}

			this.fire("changed", this.lists);

		};

		window.TodoProvider.prototype._changed = function(){

			var data = [];

			for(var i = 0; i < this.lists.length; i++)
				data.push({
					name: this.lists[i].name,
					items: this.lists[i].items
				});

			localStorage.setItem("com.example.todoList", JSON.stringify(data));

			this.fire("changed", this.lists);

		};

		window.TodoProvider.prototype.addList = function(name){
			
			this.lists.push( new TodoList(this, name) );

			this._changed();

		};

		window.TodoProvider.prototype.removeList = function(list){
			
			var index = this.lists.indexOf(list);

			if(index < 0) throw "List not found.";

			this.lists.splice(index, 1);		
			
			this._changed();

		};

	</script>

</html>